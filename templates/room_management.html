<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n L√Ω Ph√≤ng H·ªçc - EduManager</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: #4361ee; --success: #06d6a0; --warning: #ff9f1c; --danger: #ef233c; --dark: #2b2d42; }
        
        /* Badges */
        .status-badge { padding: 6px 12px; border-radius: 30px; font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; text-transform: uppercase; }
        .status-badge.available { background: rgba(6, 214, 160, 0.1); color: var(--success); border: 1px solid rgba(6, 214, 160, 0.2); }
        .status-badge.maintenance { background: rgba(255, 159, 28, 0.1); color: var(--warning); border: 1px solid rgba(255, 159, 28, 0.2); }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .available .dot { background: var(--success); box-shadow: 0 0 0 2px rgba(6, 214, 160, 0.3); }
        .maintenance .dot { background: var(--warning); box-shadow: 0 0 0 2px rgba(255, 159, 28, 0.3); }

        /* Buttons Premium */
        .btn-premium { border: none; padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 0.9rem; }
        .btn-premium:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        .btn-blue { background: linear-gradient(135deg, #4361ee, #3a0ca3); color: white; }
        .btn-purple { background: linear-gradient(135deg, #7209b7, #560bad); color: white; }
        .btn-white { background: white; color: var(--dark); border: 1px solid #eee; }
        .btn-yellow { background: linear-gradient(135deg, #ffd166, #ffb703); color: #333; }
        .btn-red { background: linear-gradient(135deg, #ef233c, #d90429); color: white; }
        .btn-disabled { background: #e0e0e0; color: #999; cursor: not-allowed; box-shadow: none; }

        /* --- B·ªò L·ªåC (M·ªöI) --- */
        .filter-group { display: flex; gap: 10px; background: #f1f3f9; padding: 5px; border-radius: 12px; }
        .filter-btn { border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.2s; color: #666; background: transparent; }
        .filter-btn:hover { color: var(--primary); background: rgba(255,255,255,0.5); }
        .filter-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(43, 45, 66, 0.6); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 8% auto; padding: 30px; border-radius: 20px; width: 450px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
        .modal-content input, .modal-content select { width: 100%; padding: 12px; margin: 8px 0 20px; border: 2px solid #f0f0f0; border-radius: 10px; font-size: 15px; box-sizing: border-box; }
        .submit-btn { width: 100%; padding: 14px; background: var(--success); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo"><i class="fas fa-graduation-cap"></i><span>EduManager</span></div>
            <nav>
                <ul>
                    <li><a href="/dashboard"><i class="fas fa-th-large"></i> T·ªïng quan</a></li>
                    {% if role == 'admin' or role == 'teacher' %}
                    <li><a href="/booking-scheduler"><i class="fas fa-calendar-alt"></i> L·ªãch ƒë·∫∑t ph√≤ng</a></li>
                    <li><a href="/room-management" class="active"><i class="fas fa-door-open"></i> Qu·∫£n l√Ω ph√≤ng h·ªçc</a></li>
                     <li><a href="/profile"><i class="fas fa-user-shield"></i> Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a></li>
                    {% endif %}
                    <li class="logout-item"><a href="/logout" style="color: #ef233c;">ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </nav>
        </aside>
        
        <main class="main-content">
            <header>
                <div class="search-bar"><i class="fas fa-search"></i><input type="text" placeholder="T√¨m ki·∫øm..."></div>
                <div class="user-profile">
                    <div class="info"><strong>{{ full_name if full_name else username }}</strong> ({{ role }})</div>
                    
                    <img src="https://ui-avatars.com/api/?name={{ full_name if full_name else username }}&background=4361ee&color=fff&size=128" alt="Avatar">
                </div>
            </header>

            <section class="data-section">
                <div class="section-header" style="justify-content: space-between; display: flex; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <h2 style="margin:0;">Ph√≤ng h·ªçc</h2>
                        
                        <div class="filter-group">
                            <button class="filter-btn active" onclick="filterStatus('all', this)">T·∫•t c·∫£</button>
                            <button class="filter-btn" onclick="filterStatus('Available', this)">Ho·∫°t ƒë·ªông</button>
                            <button class="filter-btn" onclick="filterStatus('Maintenance', this)">B·∫£o tr√¨</button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn-premium btn-purple" onclick="window.location.href='/booking-scheduler'"><i class="fas fa-calendar-week"></i> Xem L·ªãch T·ªïng</button>
                        {% if role == 'admin' %}
                        <button class="btn-premium btn-blue" onclick="showCreateRoomModal()"><i class="fas fa-plus"></i> Th√™m ph√≤ng</button>
                        {% endif %}
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="roomTable">
                        <thead><tr><th>ID</th><th>T√™n ph√≤ng</th><th>S·ª©c ch·ª©a</th><th>Thi·∫øt b·ªã</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead>
                        <tbody>
                            {% for room in classrooms %}
                            <tr class="room-row" data-status="{{ room.status }}">
                                <td><strong>#{{ room.id }}</strong></td>
                                <td><span style="font-size: 1.05rem; font-weight: 700; color: var(--dark);">{{ room.room_name }}</span></td>
                                <td>{{ room.capacity }}</td>
                                <td>{{ room.equipment }}</td>
                                <td>
                                    {% if room.status == 'Maintenance' %}
                                        <span class="status-badge maintenance"><span class="dot"></span> B·∫£o tr√¨</span>
                                    {% else %}
                                        <span class="status-badge available"><span class="dot"></span> Ho·∫°t ƒë·ªông</span>
                                    {% endif %}
                                </td>
                                <td class="actions">
                                    <button class="btn-premium btn-white" style="padding: 6px 12px; font-size: 0.8rem;" onclick="toggleDetails(this, {{ room.id }})">Chi ti·∫øt</button>
                                </td>
                            </tr>
                            
                            <tr id="details-row-{{ room.id }}" class="room-details-row" style="display: none; background: #f8f9fc;">
                                <td colspan="6" style="padding: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 style="margin: 0 0 5px 0; color: var(--primary);">{{ room.room_name }}</h4>
                                            <p style="margin: 0; color: #666; font-size: 0.9rem;">{{ room.equipment }} ‚Ä¢ {{ room.capacity }} ch·ªó ng·ªìi</p>
                                        </div>
                                        <div style="display: flex; gap: 10px;">
                                            {% if room.status == 'Maintenance' %}
                                                <button class="btn-premium btn-disabled" disabled><i class="fas fa-ban"></i> ƒêang b·∫£o tr√¨</button>
                                            {% else %}
                                                <button class="btn-premium btn-blue" onclick="window.location.href='/booking-scheduler?room_id={{ room.id }}'"><i class="fas fa-calendar-check"></i> ƒê·∫∑t l·ªãch ngay</button>
                                            {% endif %}

                                            {% if role == 'admin' %}
                                            <button class="btn-premium btn-yellow" onclick="showEditRoomModal({{ room.id }}, '{{ room.room_name }}', {{ room.capacity }}, '{{ room.equipment }}', '{{ room.status }}')"><i class="fas fa-pen"></i> S·ª≠a</button>
                                            <button class="btn-premium btn-red" onclick="deleteRoom({{ room.id }}, '{{ room.room_name }}')"><i class="fas fa-trash"></i> X√≥a</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="roomModal" class="modal">
        <div class="modal-content">
            <span onclick="closeModal()" style="float:right; cursor:pointer; font-size:24px; color: #999;">&times;</span>
            <h2 id="modalTitle">Th√¥ng Tin Ph√≤ng</h2>
            <form id="roomForm">
                <input type="hidden" id="roomId" name="room_id">
                <label>T√™n ph√≤ng:</label><input type="text" id="roomName" name="room_name" required>
                <label>S·ª©c ch·ª©a:</label><input type="number" id="roomCapacity" name="capacity" required>
                <label>Thi·∫øt b·ªã:</label><input type="text" id="roomEquipment" name="equipment" required>
                <label>Tr·∫°ng th√°i:</label>
                <select id="roomStatus" name="status">
                    <option value="Available">üü¢ Ho·∫°t ƒë·ªông</option>
                    <option value="Maintenance">üü† B·∫£o tr√¨</option>
                </select>
                <button type="submit" id="submitBtn" class="submit-btn">L∆∞u l·∫°i</button>
            </form>
        </div>
    </div>

    <script>
        // === H√ÄM L·ªåC TR·∫†NG TH√ÅI (M·ªöI) ===
        function filterStatus(status, btn) {
            // 1. C·∫≠p nh·∫≠t n√∫t active
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // 2. L·ªçc b·∫£ng
            const rows = document.querySelectorAll('.room-row');
            const details = document.querySelectorAll('.room-details-row');
            
            // ·∫®n t·∫•t c·∫£ d√≤ng chi ti·∫øt ƒë·ªÉ tr√°nh l·ªói giao di·ªán
            details.forEach(d => d.style.display = 'none');
            // Reset n√∫t "Chi ti·∫øt" v·ªÅ tr·∫°ng th√°i ƒë√≥ng
            document.querySelectorAll('.actions button').forEach(b => b.innerText = 'Chi ti·∫øt');

            rows.forEach(row => {
                const roomStatus = row.getAttribute('data-status'); // L·∫•y status t·ª´ data attribute
                if (status === 'all' || roomStatus === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // === H√ÄM T√åM KI·∫æM (ƒê√£ t√≠ch h·ª£p c√πng b·ªô l·ªçc) ===
        function searchRooms() {
            var input = document.getElementById("searchInput");
            var filter = input.value.toUpperCase();
            var rows = document.querySelectorAll('.room-row');
            
            // ·∫®n chi ti·∫øt khi search
            document.querySelectorAll('.room-details-row').forEach(d => d.style.display = 'none');

            rows.forEach(row => {
                var td = row.getElementsByTagName("td")[1]; // C·ªôt T√™n ph√≤ng
                if (td) {
                    var txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                }       
            });
        }

        const modal = document.getElementById('roomModal');
        const form = document.getElementById('roomForm');
        let currentAction = '';

        function closeModal() { modal.style.display = 'none'; form.reset(); }
        
        function showCreateRoomModal() {
            document.getElementById('modalTitle').textContent = 'Th√™m Ph√≤ng M·ªõi';
            currentAction = 'create';
            form.action = '/api/rooms/create';
            modal.style.display = 'block';
        }

        function showEditRoomModal(id, name, cap, eq, stat) {
            document.getElementById('modalTitle').textContent = 'S·ª≠a Ph√≤ng';
            currentAction = 'update';
            form.action = '/api/rooms/update';
            document.getElementById('roomId').value = id;
            document.getElementById('roomName').value = name;
            document.getElementById('roomCapacity').value = cap;
            document.getElementById('roomEquipment').value = eq;
            document.getElementById('roomStatus').value = stat;
            modal.style.display = 'block';
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(form).entries());
            data.capacity = parseInt(data.capacity);
            if(currentAction === 'update') data.room_id = parseInt(data.room_id);
            
            const res = await fetch(form.action, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            const result = await res.json();
            if(result.status === 'success') { 
                Swal.fire({ title: 'Th√†nh c√¥ng!', text: result.message, icon: 'success', confirmButtonColor: '#06d6a0' }).then(() => window.location.reload()); 
            } else { Swal.fire('L·ªói', result.message, 'error'); }
        };

        function toggleDetails(btn, id) {
            const row = document.getElementById('details-row-' + id);
            const isHidden = row.style.display === 'none';
            
            // ƒê√≥ng t·∫•t c·∫£ c√°c d√≤ng kh√°c tr∆∞·ªõc khi m·ªü (ƒë·ªÉ g·ªçn g√†ng)
            document.querySelectorAll('.room-details-row').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.actions button').forEach(b => b.innerText = 'Chi ti·∫øt');

            if(isHidden) {
                row.style.display = 'table-row';
                btn.innerText = 'ƒê√≥ng';
            } else {
                row.style.display = 'none';
                btn.innerText = 'Chi ti·∫øt';
            }
        }

        async function deleteRoom(id, name) {
            Swal.fire({
                title: `X√≥a ${name}?`, text: "Kh√¥ng th·ªÉ ho√†n t√°c!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef233c', confirmButtonText: 'X√≥a', cancelButtonText: 'H·ªßy'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const res = await fetch('/api/rooms/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({room_id: id}) });
                    const d = await res.json();
                    if(d.status==='success') Swal.fire('ƒê√£ x√≥a!', '', 'success').then(()=>window.location.reload());
                    else Swal.fire('L·ªói', d.message, 'error');
                }
            });
        }
    </script>
    <script>
        // Khi trang t·∫£i xong, ki·ªÉm tra xem c√≥ y√™u c·∫ßu l·ªçc kh√¥ng
        window.addEventListener('DOMContentLoaded', (event) => {
            const urlParams = new URLSearchParams(window.location.search);
            const filterParam = urlParams.get('filter'); // L·∫•y gi√° tr·ªã 'Available' t·ª´ URL

            if (filterParam) {
                // T√¨m n√∫t b·∫•m t∆∞∆°ng ·ª©ng v·ªõi b·ªô l·ªçc n√†y (N√∫t "Ho·∫°t ƒë·ªông")
                // filterStatus('Available', this) -> t√¨m trong onclick
                const btnToClick = document.querySelector(`button[onclick*="${filterParam}"]`);
                
                if (btnToClick) {
                    // T·ª± ƒë·ªông k√≠ch ho·∫°t h√†nh ƒë·ªông l·ªçc
                    filterStatus(filterParam, btnToClick);
                }
            }
        });
    </script>
</body>
</html>